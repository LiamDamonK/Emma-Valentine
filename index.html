<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StudyTogether ðŸ“š</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0f0e17;
        --surface: #1a1826;
        --surface2: #232136;
        --border: #2d2b3d;
        --accent: #e0a96d;
        --accent2: #9d7cd8;
        --accent3: #7dcfb6;
        --text: #f5f0e8;
        --muted: #8b849c;
        --danger: #f7768e;
        --success: #9ece6a;
        --glow: rgba(224, 169, 109, 0.15);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "DM Sans", sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Animated background */
      body::before {
        content: "";
        position: fixed;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background:
          radial-gradient(
            ellipse at 20% 20%,
            rgba(157, 124, 216, 0.08) 0%,
            transparent 50%
          ),
          radial-gradient(
            ellipse at 80% 80%,
            rgba(224, 169, 109, 0.06) 0%,
            transparent 50%
          ),
          radial-gradient(
            ellipse at 50% 50%,
            rgba(125, 207, 182, 0.04) 0%,
            transparent 60%
          );
        animation: bgShift 20s ease-in-out infinite alternate;
        pointer-events: none;
        z-index: 0;
      }

      @keyframes bgShift {
        0% {
          transform: translate(0, 0) rotate(0deg);
        }
        100% {
          transform: translate(2%, 2%) rotate(3deg);
        }
      }

      .app {
        position: relative;
        z-index: 1;
        max-width: 1300px;
        margin: 0 auto;
        padding: 24px 20px;
      }

      /* Header */
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 40px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo-icon {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        box-shadow: 0 0 20px rgba(224, 169, 109, 0.3);
      }

      .logo h1 {
        font-family: "Playfair Display", serif;
        font-size: 26px;
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .logo p {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
      }

      .user-select {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 50px;
        padding: 6px 8px;
      }

      .user-btn {
        padding: 8px 18px;
        border-radius: 40px;
        border: none;
        cursor: pointer;
        font-family: "DM Sans", sans-serif;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        background: transparent;
        color: var(--muted);
      }

      .user-btn.active {
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        color: var(--bg);
        box-shadow: 0 2px 12px rgba(224, 169, 109, 0.3);
      }

      /* Main Grid */
      .main-grid {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 28px;
      }

      @media (max-width: 900px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Calendar */
      .calendar-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 28px;
      }

      .cal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
      }

      .cal-header h2 {
        font-family: "Playfair Display", serif;
        font-size: 22px;
      }

      .cal-nav {
        display: flex;
        gap: 8px;
      }

      .cal-nav button {
        width: 34px;
        height: 34px;
        border: 1px solid var(--border);
        background: var(--surface2);
        color: var(--text);
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .cal-nav button:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .cal-grid-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-bottom: 8px;
      }

      .cal-grid-header span {
        text-align: center;
        font-size: 11px;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 4px 0;
      }

      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }

      .cal-day {
        aspect-ratio: 1;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s;
        position: relative;
        border: 1px solid transparent;
        padding: 4px;
        gap: 2px;
      }

      .cal-day:hover:not(.empty) {
        background: var(--surface2);
        border-color: var(--border);
      }

      .cal-day.today {
        background: rgba(224, 169, 109, 0.12);
        border-color: var(--accent);
        color: var(--accent);
        font-weight: 600;
      }

      .cal-day.selected {
        background: linear-gradient(
          135deg,
          rgba(224, 169, 109, 0.2),
          rgba(157, 124, 216, 0.2)
        );
        border-color: var(--accent2);
      }

      .cal-day.empty {
        cursor: default;
      }

      .cal-day.other-month {
        opacity: 0.25;
      }

      .dot-row {
        display: flex;
        gap: 2px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        min-height: 10px;
      }

      .session-dot {
        width: 5px;
        height: 5px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .tick-mark {
        position: absolute;
        top: 3px;
        right: 3px;
        font-size: 8px;
        color: var(--success);
        font-weight: 700;
      }

      /* Sidebar */
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* Day Panel */
      .day-panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px;
      }

      .day-panel h3 {
        font-family: "Playfair Display", serif;
        font-size: 18px;
        margin-bottom: 16px;
        color: var(--accent);
      }

      /* Add session form */
      .add-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .form-input {
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 14px;
        color: var(--text);
        font-family: "DM Sans", sans-serif;
        font-size: 13px;
        outline: none;
        transition: border-color 0.2s;
        width: 100%;
      }

      .form-input:focus {
        border-color: var(--accent2);
      }

      .form-input::placeholder {
        color: var(--muted);
      }

      .add-btn {
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        border: none;
        border-radius: 10px;
        padding: 11px;
        color: var(--bg);
        font-family: "DM Sans", sans-serif;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .add-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 20px rgba(224, 169, 109, 0.4);
      }

      /* Sessions list */
      .sessions-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 360px;
        overflow-y: auto;
        padding-right: 4px;
      }

      .sessions-list::-webkit-scrollbar {
        width: 4px;
      }
      .sessions-list::-webkit-scrollbar-track {
        background: transparent;
      }
      .sessions-list::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 2px;
      }

      .session-card {
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
      }

      .session-card::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        border-radius: 3px 0 0 3px;
      }

      .session-card.user-0::before {
        background: var(--accent);
      }
      .session-card.user-1::before {
        background: var(--accent2);
      }

      .session-card:hover {
        border-color: var(--accent2);
        transform: translateX(2px);
      }

      .session-card.completed {
        opacity: 0.6;
      }

      .session-card.active-timer {
        border-color: var(--success);
        box-shadow: 0 0 15px rgba(158, 206, 106, 0.2);
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          box-shadow: 0 0 15px rgba(158, 206, 106, 0.2);
        }
        50% {
          box-shadow: 0 0 25px rgba(158, 206, 106, 0.4);
        }
      }

      .session-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
      }

      .session-subject {
        font-weight: 600;
        font-size: 14px;
        padding-left: 6px;
      }

      .session-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        padding-left: 6px;
      }

      .session-time-label {
        font-size: 12px;
        color: var(--muted);
      }

      .session-duration {
        font-size: 11px;
        background: var(--surface);
        border-radius: 6px;
        padding: 2px 7px;
        color: var(--accent3);
        font-weight: 500;
      }

      .session-who {
        font-size: 11px;
        color: var(--muted);
        padding: 2px 8px;
        border-radius: 20px;
        border: 1px solid var(--border);
      }

      .session-actions {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .timer-btn {
        background: rgba(158, 206, 106, 0.15);
        border: 1px solid var(--success);
        border-radius: 8px;
        color: var(--success);
        padding: 4px 10px;
        font-size: 12px;
        cursor: pointer;
        font-family: "DM Sans", sans-serif;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .timer-btn:hover {
        background: rgba(158, 206, 106, 0.25);
      }

      .delete-btn {
        background: rgba(247, 118, 142, 0.1);
        border: 1px solid rgba(247, 118, 142, 0.3);
        border-radius: 8px;
        color: var(--danger);
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .delete-btn:hover {
        background: rgba(247, 118, 142, 0.2);
      }

      .completed-badge {
        font-size: 18px;
        line-height: 1;
      }

      /* Timer Modal */
      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px);
        z-index: 100;
        align-items: center;
        justify-content: center;
      }

      .modal-overlay.open {
        display: flex;
        animation: fadeIn 0.2s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .timer-modal {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: 40px;
        width: 380px;
        text-align: center;
        position: relative;
        animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      @keyframes slideUp {
        from {
          transform: translateY(30px) scale(0.95);
          opacity: 0;
        }
        to {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }

      .close-modal {
        position: absolute;
        top: 16px;
        right: 16px;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--muted);
        width: 32px;
        height: 32px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .close-modal:hover {
        color: var(--text);
      }

      .timer-emoji {
        font-size: 40px;
        margin-bottom: 12px;
      }

      .timer-subject {
        font-family: "Playfair Display", serif;
        font-size: 24px;
        margin-bottom: 4px;
      }

      .timer-who-label {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 28px;
      }

      .timer-ring-wrapper {
        position: relative;
        width: 180px;
        height: 180px;
        margin: 0 auto 28px;
      }

      .timer-ring {
        transform: rotate(-90deg);
      }

      .ring-bg {
        fill: none;
        stroke: var(--surface2);
        stroke-width: 8;
      }

      .ring-progress {
        fill: none;
        stroke: url(#timerGrad);
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 1s linear;
      }

      .timer-display {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .timer-time {
        font-family: "Playfair Display", serif;
        font-size: 40px;
        font-weight: 700;
        color: var(--text);
        letter-spacing: -0.02em;
        line-height: 1;
      }

      .timer-label-small {
        font-size: 11px;
        color: var(--muted);
        margin-top: 4px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .timer-controls {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .ctrl-btn {
        padding: 12px 28px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        font-family: "DM Sans", sans-serif;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
      }

      .ctrl-btn.primary {
        background: linear-gradient(135deg, var(--success), var(--accent3));
        color: var(--bg);
        flex: 1;
      }

      .ctrl-btn.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(158, 206, 106, 0.4);
      }

      .ctrl-btn.secondary {
        background: var(--surface2);
        color: var(--text);
        border: 1px solid var(--border);
      }

      .ctrl-btn.secondary:hover {
        border-color: var(--accent);
      }

      .done-btn {
        width: 100%;
        padding: 14px;
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        color: var(--bg);
        font-family: "DM Sans", sans-serif;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 12px;
      }

      .done-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 20px rgba(224, 169, 109, 0.4);
      }

      /* Legend */
      .legend {
        display: flex;
        gap: 16px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--muted);
      }

      .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 30px 16px;
        color: var(--muted);
        font-size: 13px;
      }

      .empty-state .es-emoji {
        font-size: 32px;
        margin-bottom: 8px;
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: var(--surface);
        border: 1px solid var(--success);
        border-radius: 12px;
        padding: 14px 20px;
        font-size: 14px;
        z-index: 200;
        transform: translateY(80px);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      }

      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      /* Stats strip */
      .stats-strip {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        text-align: center;
      }

      .stat-value {
        font-family: "Playfair Display", serif;
        font-size: 28px;
        font-weight: 700;
        color: var(--accent);
        line-height: 1;
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }

      .color-you {
        color: var(--accent) !important;
      }
      .color-partner {
        color: var(--accent2) !important;
      }

      select.form-input {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b849c' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 32px;
      }

      option {
        background: #1a1826;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Header -->
      <header>
        <div class="logo">
          <div class="logo-icon">ðŸ“š</div>
          <div>
            <h1>StudyTogether</h1>
            <p>Your shared study planner</p>
          </div>
        </div>
        <div class="user-select">
          <button class="user-btn active" id="userYou" onclick="setUser(0)">
            ðŸ‘¤ You
          </button>
          <button class="user-btn" id="userPartner" onclick="setUser(1)">
            ðŸ’œ Partner
          </button>
        </div>
      </header>

      <!-- Stats -->
      <div class="stats-strip">
        <div class="stat-card">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">Sessions Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value color-you" id="statYou">0</div>
          <div class="stat-label">Your Sessions âœ“</div>
        </div>
        <div class="stat-card">
          <div class="stat-value color-partner" id="statPartner">0</div>
          <div class="stat-label">Partner Sessions âœ“</div>
        </div>
      </div>

      <!-- Main Grid -->
      <div class="main-grid">
        <!-- Calendar -->
        <div class="calendar-card">
          <div class="cal-header">
            <h2 id="calTitle">Month Year</h2>
            <div class="cal-nav">
              <button onclick="changeMonth(-1)">â€¹</button>
              <button onclick="changeMonth(1)">â€º</button>
            </div>
          </div>
          <div class="cal-grid-header">
            <span>Sun</span><span>Mon</span><span>Tue</span> <span>Wed</span
            ><span>Thu</span><span>Fri</span><span>Sat</span>
          </div>
          <div class="cal-grid" id="calGrid"></div>
          <div class="legend">
            <div class="legend-item">
              <div class="legend-dot" style="background: var(--accent)"></div>
              Your sessions
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background: var(--accent2)"></div>
              Partner's sessions
            </div>
            <div class="legend-item">
              <span style="color: var(--success); font-size: 14px">âœ“</span>
              Completed
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
          <div class="day-panel">
            <h3 id="dayTitle">Select a day</h3>

            <!-- Add session form -->
            <div class="add-form">
              <input
                class="form-input"
                id="subjectInput"
                placeholder="Subject (e.g. Math, Biology...)"
              />
              <div class="form-row">
                <input class="form-input" id="timeInput" type="time" />
                <select class="form-input" id="durationInput">
                  <option value="15">15 min</option>
                  <option value="30">30 min</option>
                  <option value="45">45 min</option>
                  <option value="60" selected>1 hour</option>
                  <option value="90">1.5 hours</option>
                  <option value="120">2 hours</option>
                  <option value="180">3 hours</option>
                </select>
              </div>
              <button class="add-btn" onclick="addSession()">
                + Add Session
              </button>
            </div>

            <!-- Sessions -->
            <div class="sessions-list" id="sessionsList">
              <div class="empty-state">
                <div class="es-emoji">ðŸ“…</div>
                Pick a day to add study sessions
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Timer Modal -->
    <div class="modal-overlay" id="timerModal">
      <div class="timer-modal">
        <button class="close-modal" onclick="closeTimer()">âœ•</button>
        <div class="timer-emoji" id="timerEmoji">ðŸ“–</div>
        <div class="timer-subject" id="timerSubject">Subject</div>
        <div class="timer-who-label" id="timerWho">Who's studying</div>

        <div class="timer-ring-wrapper">
          <svg
            class="timer-ring"
            width="180"
            height="180"
            viewBox="0 0 180 180"
          >
            <defs>
              <linearGradient
                id="timerGrad"
                x1="0%"
                y1="0%"
                x2="100%"
                y2="100%"
              >
                <stop offset="0%" style="stop-color: var(--success)" />
                <stop offset="100%" style="stop-color: var(--accent3)" />
              </linearGradient>
            </defs>
            <circle class="ring-bg" cx="90" cy="90" r="80" />
            <circle
              class="ring-progress"
              id="ringProgress"
              cx="90"
              cy="90"
              r="80"
              stroke-dasharray="502.65"
              stroke-dashoffset="0"
            />
          </svg>
          <div class="timer-display">
            <div class="timer-time" id="timerDisplay">00:00</div>
            <div class="timer-label-small" id="timerStatus">ready</div>
          </div>
        </div>

        <div class="timer-controls" id="timerControls">
          <button class="ctrl-btn secondary" onclick="closeTimer()">
            Cancel
          </button>
          <button
            class="ctrl-btn primary"
            id="startPauseBtn"
            onclick="startPauseTimer()"
          >
            â–¶ Start
          </button>
        </div>
        <button
          class="done-btn"
          id="doneBtn"
          style="display: none"
          onclick="finishSession()"
        >
          âœ“ Mark as Complete!
        </button>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
      <span>ðŸŽ‰</span>
      <span id="toastMsg">Session completed!</span>
    </div>

    <script>
      // ==================== STATE ====================
      let currentUser = 0; // 0 = you, 1 = partner
      let selectedDate = null;
      let currentMonth = new Date();
      let sessions = {}; // { "YYYY-MM-DD": [...sessions] }
      let timerSession = null;
      let timerInterval = null;
      let timerRunning = false;
      let timerSeconds = 0;
      let timerTotal = 0;
      let timerDateKey = null;
      let timerSessionId = null;

      const USERS = [
        { name: "You", color: "var(--accent)", emoji: "ðŸ‘¤" },
        { name: "Partner", color: "var(--accent2)", emoji: "ðŸ’œ" },
      ];

      const SUBJECT_EMOJIS = {
        math: "ðŸ”¢",
        biology: "ðŸ§¬",
        chemistry: "âš—ï¸",
        physics: "âš¡",
        history: "ðŸ“œ",
        english: "ðŸ“",
        science: "ðŸ”¬",
        art: "ðŸŽ¨",
        music: "ðŸŽµ",
        coding: "ðŸ’»",
        programming: "ðŸ’»",
        computer: "ðŸ’»",
        spanish: "ðŸ‡ªðŸ‡¸",
        french: "ðŸ‡«ðŸ‡·",
        german: "ðŸ‡©ðŸ‡ª",
        language: "ðŸŒ",
        economics: "ðŸ“Š",
        geography: "ðŸ—ºï¸",
        philosophy: "ðŸ¤”",
        psychology: "ðŸ§ ",
        literature: "ðŸ“š",
        writing: "âœï¸",
        reading: "ðŸ“–",
        default: "ðŸ“š",
      };

      function getEmoji(subject) {
        const key = (subject || "").toLowerCase();
        for (const [k, v] of Object.entries(SUBJECT_EMOJIS)) {
          if (key.includes(k)) return v;
        }
        return SUBJECT_EMOJIS.default;
      }

      // ==================== STORAGE ====================
      async function saveData() {
        try {
          await window.storage.set(
            "study-sessions",
            JSON.stringify(sessions),
            true,
          );
        } catch (e) {
          console.log("Storage save error", e);
        }
      }

      async function loadData() {
        try {
          const res = await window.storage.get("study-sessions", true);
          if (res && res.value) {
            sessions = JSON.parse(res.value);
          }
        } catch (e) {
          sessions = {};
        }
        renderCalendar();
        updateStats();
        if (selectedDate) renderSessions();
      }

      // ==================== USER ====================
      function setUser(u) {
        currentUser = u;
        document.getElementById("userYou").className =
          "user-btn" + (u === 0 ? " active" : "");
        document.getElementById("userPartner").className =
          "user-btn" + (u === 1 ? " active" : "");
      }

      // ==================== CALENDAR ====================
      function dateKey(d) {
        return d.toISOString().slice(0, 10);
      }

      function changeMonth(dir) {
        currentMonth.setMonth(currentMonth.getMonth() + dir);
        renderCalendar();
      }

      function renderCalendar() {
        const months = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        document.getElementById("calTitle").textContent =
          `${months[month]} ${year}`;

        const grid = document.getElementById("calGrid");
        grid.innerHTML = "";

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const prevDays = new Date(year, month, 0).getDate();
        const today = new Date();
        const todayKey = dateKey(today);

        // Prev month days
        for (let i = firstDay - 1; i >= 0; i--) {
          const d = document.createElement("div");
          d.className = "cal-day other-month";
          d.innerHTML = `<span>${prevDays - i}</span><div class="dot-row"></div>`;
          grid.appendChild(d);
        }

        // Current month
        for (let day = 1; day <= daysInMonth; day++) {
          const d = new Date(year, month, day);
          const key = dateKey(d);
          const daySessions = sessions[key] || [];
          const completed = daySessions.filter((s) => s.completed).length;

          let cls = "cal-day";
          if (key === todayKey) cls += " today";
          if (selectedDate && key === selectedDate) cls += " selected";

          // Dots
          const userDots = [
            daySessions.filter((s) => s.user === 0),
            daySessions.filter((s) => s.user === 1),
          ];
          let dotsHtml = '<div class="dot-row">';
          const dotColors = ["var(--accent)", "var(--accent2)"];
          userDots.forEach((ud, ui) => {
            const col = dotColors[ui];
            ud.slice(0, 3).forEach(() => {
              dotsHtml +=
                '<div class="session-dot" style="background:' +
                col +
                '"></div>';
            });
          });
          dotsHtml += "</div>";

          const tickHtml =
            completed > 0
              ? `<span class="tick-mark">âœ“${completed > 1 ? completed : ""}</span>`
              : "";

          const el = document.createElement("div");
          el.className = cls;
          el.innerHTML = `${tickHtml}<span>${day}</span>${dotsHtml}`;
          el.onclick = () => selectDay(key, day);
          grid.appendChild(el);
        }

        // Fill remaining
        const total = firstDay + daysInMonth;
        const remaining = total % 7 === 0 ? 0 : 7 - (total % 7);
        for (let i = 1; i <= remaining; i++) {
          const d = document.createElement("div");
          d.className = "cal-day other-month";
          d.innerHTML = `<span>${i}</span><div class="dot-row"></div>`;
          grid.appendChild(d);
        }
      }

      function selectDay(key, day) {
        selectedDate = key;
        const months = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        const [y, m, d2] = key.split("-").map(Number);
        const dow = [
          "Sunday",
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
        ][new Date(y, m - 1, d2).getDay()];
        document.getElementById("dayTitle").textContent =
          `${dow}, ${months[m - 1]} ${d2}`;

        // Default time to now
        const now = new Date();
        document.getElementById("timeInput").value =
          `${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;

        renderCalendar();
        renderSessions();
      }

      // ==================== SESSIONS ====================
      function addSession() {
        if (!selectedDate) {
          showToast("Pick a day first! ðŸ“…", "#f7768e");
          return;
        }
        const subject = document.getElementById("subjectInput").value.trim();
        const time = document.getElementById("timeInput").value;
        const duration = parseInt(
          document.getElementById("durationInput").value,
        );
        if (!subject) {
          showToast("Enter a subject! âœï¸", "#f7768e");
          return;
        }
        if (!sessions[selectedDate]) sessions[selectedDate] = [];

        const session = {
          id: Date.now(),
          subject,
          time: time || "09:00",
          duration,
          user: currentUser,
          completed: false,
          emoji: getEmoji(subject),
        };

        sessions[selectedDate].push(session);
        sessions[selectedDate].sort((a, b) => a.time.localeCompare(b.time));
        saveData();
        renderCalendar();
        renderSessions();
        updateStats();
        document.getElementById("subjectInput").value = "";
        showToast("Session added! ðŸ“š");
      }

      function renderSessions() {
        const list = document.getElementById("sessionsList");
        const daySessions = sessions[selectedDate] || [];

        if (!selectedDate) {
          list.innerHTML =
            '<div class="empty-state"><div class="es-emoji">ðŸ“…</div>Pick a day to add study sessions</div>';
          return;
        }

        if (daySessions.length === 0) {
          list.innerHTML =
            '<div class="empty-state"><div class="es-emoji">âœ¨</div>No sessions yet. Add one above!</div>';
          return;
        }

        list.innerHTML = daySessions
          .map((s) => {
            const isActive = timerSessionId === s.id;
            const dur =
              s.duration >= 60 ? s.duration / 60 + "h" : s.duration + "m";
            const cardCls =
              "session-card user-" +
              s.user +
              (s.completed ? " completed" : "") +
              (isActive ? " active-timer" : "");
            const actionBtn = s.completed
              ? '<span class="completed-badge">&#x2705;</span>'
              : '<button class="timer-btn" onclick="openTimer(\'' +
                selectedDate +
                "'," +
                s.id +
                ')">&#x23F1; Start</button>';
            const deleteBtn =
              '<button class="delete-btn" onclick="deleteSession(\'' +
              selectedDate +
              "'," +
              s.id +
              ')">&times;</button>';
            return (
              '<div class="' +
              cardCls +
              '" id="sc-' +
              s.id +
              '">' +
              '<div class="session-top">' +
              '<div class="session-subject">' +
              s.emoji +
              " " +
              s.subject +
              "</div>" +
              '<div class="session-actions">' +
              actionBtn +
              deleteBtn +
              "</div>" +
              "</div>" +
              '<div class="session-meta">' +
              '<span class="session-time-label">&#x1F550; ' +
              s.time +
              "</span>" +
              '<span class="session-duration">' +
              dur +
              "</span>" +
              '<span class="session-who">' +
              USERS[s.user].emoji +
              " " +
              USERS[s.user].name +
              "</span>" +
              "</div>" +
              "</div>"
            );
          })
          .join("");
      }

      function deleteSession(dateKey, id) {
        sessions[dateKey] = (sessions[dateKey] || []).filter(
          (s) => s.id !== id,
        );
        saveData();
        renderCalendar();
        renderSessions();
        updateStats();
      }

      function updateStats() {
        const all = Object.values(sessions).flat();
        document.getElementById("statTotal").textContent = all.length;
        document.getElementById("statYou").textContent = all.filter(
          (s) => s.user === 0 && s.completed,
        ).length;
        document.getElementById("statPartner").textContent = all.filter(
          (s) => s.user === 1 && s.completed,
        ).length;
      }

      // ==================== TIMER ====================
      function openTimer(dateKey2, id) {
        const daySessions = sessions[dateKey2] || [];
        const session = daySessions.find((s) => s.id === id);
        if (!session) return;

        timerSession = session;
        timerDateKey = dateKey2;
        timerSessionId = id;
        timerTotal = session.duration * 60;
        timerSeconds = timerTotal;
        timerRunning = false;
        clearInterval(timerInterval);

        document.getElementById("timerEmoji").textContent = session.emoji;
        document.getElementById("timerSubject").textContent = session.subject;
        document.getElementById("timerWho").textContent =
          `${USERS[session.user].emoji} ${USERS[session.user].name}'s session`;
        document.getElementById("timerStatus").textContent = "ready";
        document.getElementById("startPauseBtn").textContent = "â–¶ Start";
        document.getElementById("timerControls").style.display = "flex";
        document.getElementById("doneBtn").style.display = "none";

        updateTimerDisplay();
        document.getElementById("timerModal").classList.add("open");
        renderSessions();
      }

      function closeTimer() {
        clearInterval(timerInterval);
        timerRunning = false;
        timerSessionId = null;
        document.getElementById("timerModal").classList.remove("open");
        renderSessions();
      }

      function startPauseTimer() {
        if (timerRunning) {
          timerRunning = false;
          clearInterval(timerInterval);
          document.getElementById("startPauseBtn").textContent = "â–¶ Resume";
          document.getElementById("timerStatus").textContent = "paused";
        } else {
          timerRunning = true;
          document.getElementById("startPauseBtn").textContent = "â¸ Pause";
          document.getElementById("timerStatus").textContent = "studying...";
          timerInterval = setInterval(() => {
            timerSeconds--;
            updateTimerDisplay();
            if (timerSeconds <= 0) {
              clearInterval(timerInterval);
              timerRunning = false;
              timerComplete();
            }
          }, 1000);
        }
      }

      function updateTimerDisplay() {
        const m = Math.floor(timerSeconds / 60);
        const s = timerSeconds % 60;
        document.getElementById("timerDisplay").textContent =
          `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;

        const progress = timerSeconds / timerTotal;
        const circumference = 502.65;
        document.getElementById("ringProgress").style.strokeDashoffset =
          circumference * (1 - (1 - progress));
        // Actually: full = 0 offset, empty = circumference offset
        document.getElementById("ringProgress").style.strokeDashoffset =
          circumference * progress;
      }

      function timerComplete() {
        document.getElementById("timerStatus").textContent = "ðŸŽ‰ Done!";
        document.getElementById("timerControls").style.display = "none";
        document.getElementById("doneBtn").style.display = "block";
        document.getElementById("ringProgress").style.strokeDashoffset = "0";
        // Play bell-ish
        try {
          const ctx = new AudioContext();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g);
          g.connect(ctx.destination);
          o.frequency.setValueAtTime(880, ctx.currentTime);
          o.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.5);
          g.gain.setValueAtTime(0.3, ctx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);
          o.start();
          o.stop(ctx.currentTime + 1);
        } catch (e) {}
      }

      function finishSession() {
        const daySessions = sessions[timerDateKey] || [];
        const session = daySessions.find((s) => s.id === timerSessionId);
        if (session) {
          session.completed = true;
          saveData();
        }
        updateStats();
        renderCalendar();
        closeTimer();
        showToast(
          `âœ“ ${session ? session.subject : "Session"} complete! Well done! ðŸŽ‰`,
        );
        renderSessions();
      }

      // ==================== TOAST ====================
      function showToast(msg, color) {
        const t = document.getElementById("toast");
        document.getElementById("toastMsg").textContent = msg;
        t.style.borderColor = color || "var(--success)";
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 3000);
      }

      // ==================== INIT ====================
      async function init() {
        await loadData();
        // Select today by default
        const today = new Date();
        selectDay(dateKey(today), today.getDate());
      }

      // Reload shared data periodically
      setInterval(async () => {
        if (!timerRunning) {
          await loadData();
        }
      }, 15000);

      init();
    </script>
  </body>
</html>
